## 1장 동시성 소개
### 무어의 법칙, 웹 스케일, 그리고 혼란
- 무어의 법칙: 집적 회로의 구성 요소가 매년 두배로 늘어날 것, 2012년까지 거의 들어맞았다. 그 이후로 둔화
- 가만히 있어도 CPU의 속도가 빨라지는 시대는 끝났다. (공짜 점심은 끝났다.)
- 그래서 CPU 안의 코어의 수를 늘리는 방향으로 발전 중이다.
- 높은 수준의 동시성 프로그래밍 모델이 필요하다.

### 동시성이 어려운 이유
- race condition
  - 둘 이상의 작업이 올바른 순서로 실행돼야 하지만 프로그램이 그렇게 작성되지 않아서 이 순서가 유지되는 것이 보장되지 않을 때 발생한다.
  - 대부분의 레이스 컨디션은 하나의 동시 작업이 어떤 변수를 읽으려고 시도하는 동안 다른 동시 작업이 특정할 수 없는 시점에 동일 변수에 값을 쓰려고 하는 데이터 레이스이다.
  - 데이터 레이스는 개발자가 문제를 순차적으로 생각하기 때문에 일어난다.
  - 동시성 코드를 작성할 때에는 가능한 한 시나리오를 세심하게 반복해야한다.

- atomicity(원자성)
  - 원자성이란 동작하는 컨텍스트 내에서 나누어지거나 중단되지 않는다는 것을 의미
  - 컨텍스트: 어떤 컨텍스트에서는 원자적인 것이 다른 컨텍스트에서는 아닐 수 있다. 프로세스 수준에선 원자적인 것이 운영체제 컨텍스트에서는 아닐 수 있다.
  - 원자성에 대해서 생각할 때 가장 먼저 할 일은 연산이 원자적인 것으로 간주할 컨텍스트를 정의하는 것이다.
  - 연산을 원자적으로 만드는 것은 사용자가 어떤 컨텍스트에서 원자성을 얻고자 하는지에 달려있다.
  - 대부분의 구문들은 원자적이지 않다. 다양한 기법을 통해서 원자성을 강제할 수 있다.

- 메모리 접근 동기화
  - 데이터 레이스 상황에서 두 프로세스가 동일한 메모리 영역에 접근하려고 시도.
  - 공유 리소스에 독점적으로 접근해야하는 영역을 critical section이라 부른다.
  - 아래 코드에서는 세 군데 critical section이 있다.
  - critical section
    - goroutine 안에서 data 증가시키는 부분
    - if data==0 에서 data에 접근하는 부분
    - Printf에서 data에 접근하는 부분
  - 이를 Mutex 등을 통해서 동기화 시킬 수 있다.
```
var data int
go func() { data++ }()
if data==0 {
  fmt.Println("the value is 0.")
} else {
  fmt.Printf("the value is %v.\n", data)
}
```
- 데드락, 라이브락, 기아 상태
  - 데드락
    - 데드락 발생 시 실행 중인 모든 프로세스는 자신이 아닌 다른 프로세스가 끝나기만을 기다림
    - 데드락은 외부 개입 없이는 결코 프로그램을 복구할 수 없음
    - go 런타임이 일부 데드락을 탐지하는 등의 역할을 수행하지만, 그렇다고 데드락 방지에 많은 도움이 되지는 않는다.
    - 데드락은 mutual exclusion, non-preemptive, circular wait, wait for condition 네 가지 조건이 충족되야 발생한다.
    - 네 가지 조건 중 하나라도 만족되지 않으면 데드락은 발생하지 안흔ㄴ다. 그러나 이를 예방하기란 쉽지 않아서 발생을 감지하고 복구하느 방식으로 대응한다.
  - 라이브락
    - 프로그램들이 활동적으로 동시에 연산을 수행하고는 있지만 이 연산들이 실제로 프로그램의 상태를 진행시키는 데 아무런 영향을 주지 못하는 의미 없는 상태.
    - 두 개 이상의 프로세스가 아무런 조정 없이 데드락을 방지하려고 시도하는 상황에서 발생
    - 프로그램이 마치 동작하는 것처럼 보이기 때문에 더 알아차리기 어려움
  - 기아 상태
    - 어떤 동시 프로세스가 작업을 수행하는데 필요한 모든 리소스를 얻을 수 없는 모든 상황을 말함
    - 임계 영역을 벗어난 후에도 불필요하게 공유 잠금을 보유함 -> 다른 프로세스들 기아 상태 발생
    - 동기화 범위가 광범위하면 기아 상태가 발생한다. 따라서 최소한의 임계 영역에 동기화를 적용할 것을 권장한다.

- 동시 프로그램 주석
  - 동시 프로그램에서의 주석은 다음과 같은 내용을 포함해야한다.
    - 누가 동시성을 책임지는가?
    - 문제 공간은 동시성 기본 요소에 어떻게 매핑 되는가?
    - 동기화는 누가 담당하는가?

- go언어에서의 동시성 프로그래밍
  - go 언어에서의 동시성 코드 모델링 방식은 정확성, 합성 가능성, 확정성을 높여준다.
  - go가 동시성을 처리하는 방식은 실제로 문제 영역을 명확하게 표현하는 데 도움을 줄 수 있다.
  - go는 고성능의 GC를 제공하여 메모리 관리에 대한 부담을 줄여준다.
  - go 런타임은 동시 연산을 운영체제 스레드로 다중화 하는 일도 자동으로 처리한다.
