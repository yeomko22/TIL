### 파드 레이어 네트워킹
- 노드간에 퍼져있는 파드간에 네트워킹 문제를 어떻게 해결할 것인가?
- 모든 파드는 유니크한 IP를 갖는다.
- 모든 파드는 같은 노드 내의 다른 파드들과 통신할 수 있다.
- 모든 파드는 NAT을 거치지 않고 다른 노드안의 파드와 통신할 수 있다.
- 이러한 문제를 CNI를 통해서 해결한다.

### 멀티 노드 네트워킹
- 각 노드 안에 브릿지를 생성한다.
- 파드 별로 네임스페이스가 생성되고, 파드 별로 IP가 할당된다.
- 파드는 CNI를 통해서 호스트 인터페이스와 연결된다. 이 때 어느 CNI 솔루션을 쓸지에 따라서 세부적인 구현은 달라질 수 있다.
- 클러스터를 구성하는 모든 노드들은 호스트 인터페이스를 통해서 하나의 네트워크로 연결된다. 그리고 여기에 라우터를 두고 각각의 파드들의 IP와 게이트웨이를 테이블 형식으로 관리하게 된다.
- 그 결과로 서로 다른 노드에 있는 파드가 라우터를 통해서 게이트웨이를 찾고, 이를 경유해서 서로 통신할 수 있게 된다.

### CNI in kubernetes
- kubelet.service 파일을 열어보면 netwokr-plugin을 설정하는 부분이 있으며, cni로 기본 설정이 되어 있다. --cin-bin-dir과 --cni-conf-dir을 설정할 수 있다.

### CNI weave
- weave는 쿠버네티스 클러스터를 구성하는 모든 노드에 weave용 브릿지를 설치한다. 그리고 모든 weave 브릿지들은 서로 긴밀하게 통신한다.
- 파드에서 데이터를 전송하고자 하면 weave가 이 패킷을 낚아채서 weave용 패킷으로 한겹 감싸서 전송한다.
- 수신하는 파드의 노드의 weave가 이를 받아서 원래의 패킷을 복원한 다음, 수신 파드에게 전달해준다.
- 바로 이 파드와 호스트 인터페이스를 연결하는 부분을 cni 플러그인을 통해서 실행하는 것이다.

### Deploy Weave
```bash
$  kubectl apply -f "https://cloud.weave.workds/k8s/net?k8s-version=$(kubectl version | base64 | tr -d '\n')"
>> daemonset 형태로 클러스터 내 모든 노드에 위브 오브젝트가 배포된다.
```

### IPAM (IP address management)
- 어떻게 노드 내에서 파드와 브릿지에 IP를 부여하는가, 어떻게 겹치지 않게 부여할 수 있는가
- CNI의 DHCP, host-local 플러그인이 이러한 기능을 담당한다.
- /etc/cni/net.d/net-script.conf에서 ipam 플러그인 유형을 선택할 수 있다. host-local이 기본값이며 DHCP도 가능하다.

